#!/usr/bin/env sh
set -e

echo "ğŸ”’ Pre-commit hook: Running quality checks..."
echo ""

branch="$(git rev-parse --abbrev-ref HEAD)"
if [ "$branch" = "main" ]; then
  echo "âŒ You are on main. Switch to staging before committing."
  exit 1
fi

echo "ğŸ§¹ Cleaning build artifacts..."
pnpm -r run clean

echo "ğŸ” Running ESLint (0 warnings allowed)..."
if ! pnpm lint; then
  echo ""
  echo "âŒ LINT FAILED - Fix all errors before committing!"
  echo "   Tip: Run 'pnpm lint' to see errors"
  echo "   DO NOT use --no-verify to bypass this check"
  exit 1
fi

echo "âœ… Lint passed!"
echo ""

echo "ğŸ”§ Running TypeScript compiler check..."
if ! pnpm exec tsc --project tsconfig.json --noEmit; then
  echo ""
  echo "âŒ TYPE CHECK FAILED - Fix all type errors before committing!"
  exit 1
fi

echo "âœ… Type check passed!"
echo ""

echo "ğŸ§ª Running tests..."
if ! pnpm vitest --run --silent; then
  echo ""
  echo "âŒ TESTS FAILED - Fix failing tests before committing!"
  exit 1
fi

echo "âœ… Tests passed!"
echo ""
echo "âœ… All pre-commit checks passed! Proceeding with commit..."
